# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SnapTimer is a portable Windows countdown timer written in **Free Pascal** using the **Lazarus IDE** (LCL framework). It is a GUI application with no external dependencies beyond the standard Windows API.

## Building

This project is built with the **Lazarus IDE**. Open `snaptimer.lpi` in Lazarus and use Build > Build All.

From the command line (if `lazbuild` is in PATH):
```
lazbuild snaptimer.lpi
```

**Clean build artifacts:**
```
clean.bat
```
This removes: `*.o *.or *.ppu *.compiled *.lrs *.rc *.res *.exe`

**Deploy (after building):**
```
deploy.bat
```
Copies `snaptimer.exe`, `Readme.txt`, and the `sounds/` folder into `releases/`.

## Testing

There is no automated test framework. Manual tests are listed in `Tests.txt`. Run through those scenarios when making changes, particularly:
- All `.ini` settings round-trip correctly
- Countdown, stopwatch, pause/resume, and reset behavior
- Command line argument (integer minutes)
- Running from a different directory (relative path resolution for sounds/ini)

## Release Steps

See `Release.txt`. Key steps: update `version.inc`, update version info in Lazarus Project Options (Version Info tab), build in release mode, run `deploy.bat`.

## Architecture

### Units

- **`snaptimer.lpr`** — Entry point. Creates `TMainForm` and runs the application.
- **`mainform1.pas`** — Core logic. `TMainForm` owns all timer state and settings as private fields.
- **`settings.pas`** — `TOptionsForm` (modal settings dialog with General, Alarms, and Fonts tabs).
- **`about.pas`** — `TAboutForm` (simple about dialog; reads version string from `version.inc`).
- **`floating.pas`** — Stub for an unfinished floating/compact window; currently unused.
- **`version.inc`** — Single-line include file containing the version string (e.g., `'0.4'`).

### Form Layout Files

Each `.pas` unit has a paired `.lfm` (Lazarus Form file, XML-like UI layout) and a compiled `.lrs` resource. The `.lrs` files are included at unit initialization via `{$I filename.lrs}` and are regenerated by Lazarus on build. Do not edit `.lrs` files manually.

### Key Design Patterns

**Timer mechanics:** `TMainForm` uses a `TTimer` (150ms interval) whose `.Tag` property stores the current remaining seconds. Accuracy is achieved using `TDateTime` math: `EndTime` is set at start, and `SecondsBetween(EndTime, Now)` is used each tick rather than decrementing a counter. Stopwatch mode uses `StartTime` similarly.

**Two modes:** `TMode = (Timer, Stopwatch)`. Setting `Minutes` to 0 activates Stopwatch mode on start.

**Settings persistence:** All settings are read from and written to `snaptimer.ini`, located in the same directory as the executable (`IniFilename := ExtractFilePath(Application.ExeName) + ChangeFileExt(AppName, '.ini')`). The INI has sections: `[Main]`, `[Alarms]`, `[Placement]`, `[Fonts]`. Auto-save on exit is controlled by the `AutoSave` flag.

**Relative path resolution:** `TMainForm.GetFilePath` converts any path starting with `.` to be relative to the exe directory. All sound file paths use this (e.g., `.\sounds\alarm_clock_bell.wav`).

**Settings dialog interaction:** `TMainForm.ShowOptions` creates `TOptionsForm`, populates its fields from main form state, calls `ShowModal`, then reads values back on `mrOk`. `TOptionsForm` calls back into `TMainForm` (via `Self.Owner as TMainForm`) for test operations (play audio, show message, run app, show tray message).

**Audio:** Windows-only via `MMSystem.sndPlaySound`. Looping uses `SND_LOOP or SND_ASYNC`. Ticking sound plays while timer is running (separate from alarm audio). Only one audio stream plays at a time (`AudioPlaying` flag gates `PlayAudio`).

**System tray:** Four icons indicate state — main (idle), running, paused, done. The tray tooltip and `Application.Title` show the current countdown time while running.

**Window positioning:** Uses `SetWindowPos` (Windows API) on form show to place the window per the `TPosition` enum: Center, Remember, TopLeft, TopRight, BottomLeft, BottomRight.
